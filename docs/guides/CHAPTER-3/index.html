<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/accenture/mercury-nodejs/guides/CHAPTER-3/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Chapter-3 - Composable for Node.js</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Chapter-3";
        var mkdocs_page_input_path = "guides/CHAPTER-3.md";
        var mkdocs_page_url = "/accenture/mercury-nodejs/guides/CHAPTER-3/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Composable for Node.js
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../METHODOLOGY/">Methodology</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-1/">Chapter-1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-2/">Chapter-2</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Chapter-3</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#turn-on-the-rest-automation-engine">Turn on the REST automation engine</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#defining-a-rest-endpoint">Defining a REST endpoint</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cors-section">CORS section</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#headers-section">HEADERS section</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#feature-variation-from-the-java-version">Feature variation from the Java version</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-4/">Chapter-4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-5/">Chapter-5</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-6/">Chapter-6</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-7/">Chapter-7</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-8/">Chapter-8</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../APPENDIX-I/">Appendix-I</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../APPENDIX-II/">Appendix-II</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG/">Release notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../arch-decisions/DESIGN-NOTES/">Design notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../INCLUSIVITY/">Inclusivity</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CODE_OF_CONDUCT/">Code of Conduct</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING/">Contribution</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../TABLE-OF-CONTENTS/">Contents</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Composable for Node.js</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Chapter-3</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="rest-automation">REST automation</h1>
<p>The foundation library contains a built-in non-blocking HTTP server that you can use to create REST
endpoints. Behind the curtain, it is using the Express server library, and we extend it to support dynamic creation
of REST endpoints.</p>
<p>The REST automation system is not a code generator. The REST endpoints in the rest.yaml file are handled by
the system directly - "Config is the code".</p>
<p>We will use the "rest.yaml" sample configuration file in the "composable-example" app to elaborate the configuration
approach.</p>
<p>The rest.yaml configuration has three sections:</p>
<ol>
<li>REST endpoint definition</li>
<li>CORS header processing</li>
<li>HTTP header transformation</li>
</ol>
<h2 id="turn-on-the-rest-automation-engine">Turn on the REST automation engine</h2>
<p>REST automation is optional. To turn on REST automation, add the REST automation start up script in your main app:</p>
<pre><code class="language-javascript">import { Logger, Platform, RestAutomation } from 'mercury-composable';
import { ComposableLoader } from '../preload/preload.js'; 
...
async function main() {
    // Load composable functions into memory and initialize configuration management
    ComposableLoader.initialize();  
    // keep the server running
    const platform = Platform.getInstance();
    platform.runForever();
    log.info('Composable application started');
}
main();
</code></pre>
<blockquote>
<p><em>Note</em>: The class "preload.ts" is automatically generated when you do "npm run preload" or "npm run build".
  The compiled file is located in the "dist/preload/preload.js". Therefore, you must use an import statement for
  '../preload/preload.js'.</p>
</blockquote>
<p>Please review the "composable-example.ts" for more details.</p>
<p>The <code>yaml.rest.automation</code> parameter in the application.yml file tells the system the location of the rest.yaml 
configuration file. The default value is "classpath:/rest.yaml". The <code>classpath:/</code> prefix means that the config
file is available under the "src/resources" folder in your project. If you want the rest.yaml configuration
file to be externalized to the local file system, you can use the <code>file:/</code> prefix. e.g. "file:/tmp/config/rest.yaml".</p>
<pre><code class="language-yaml">yaml.rest.automation: 'classpath:/rest.yaml'
</code></pre>
<h2 id="defining-a-rest-endpoint">Defining a REST endpoint</h2>
<p>The "rest" section of the rest.yaml configuration file may contain one or more REST endpoints.</p>
<p>A REST endpoint may look like this:</p>
<pre><code class="language-yaml">  - service: [&quot;hello.world&quot;]
    methods: ['GET', 'PUT', 'POST', 'HEAD', 'PATCH', 'DELETE']
    url: &quot;/api/hello/world&quot;
    timeout: 10s
    cors: cors_1
    headers: header_1
    authentication: 'v1.api.auth'
    tracing: true
</code></pre>
<p>In this example, the URL for the REST endpoint is "/api/hello/world" and it accepts a list of HTTP methods.
When an HTTP request is sent to the URL, the HTTP event will be sent to the function declared with service
route name "hello.world". The input event "body" will be an "AsyncHttpRequest" object. You can retrieve HTTP
metadata such as method, url path, HTTP request headers from the object.</p>
<p>The "timeout" value is the maximum time that REST endpoint will wait for a response from your function.
If there is no response within the specified time interval, the user will receive an HTTP-408 timeout exception.</p>
<p>The "authentication" tag is optional. If configured, the route name given in the authentication tag will be used.
The input event will be delivered to a function with the authentication route name. In this example, it is
"v1.api.auth".</p>
<p>Your custom authentication function may look like this:</p>
<pre><code class="language-javascript">export class DemoAuth implements Composable {

    @preload('v1.api.auth')
    initialize(): Composable {
        return this;
    }

    async handleEvent(evt: EventEnvelope) {
        const req = new AsyncHttpRequest(evt.getBody() as object);
        const method = req.getMethod();
        const url = req.getUrl();
        log.info(`${method} ${url} authenticated`);
        // this is a demo so we approve all requests
        return true;
    }
}
</code></pre>
<p>Your authentication function can return a boolean value to indicate if the request should be accepted or rejected.
Optionally, you can also return an EventEnvelope containing a boolean body and a set of key-values in the headers.</p>
<p>If true, the system will send the HTTP request to the service. In this example, it is the "hello.world" function.
If false, the user will receive an "HTTP-401 Unauthorized" exception.</p>
<p>Optionally, you can use the authentication function to return some session information after authentication.
For example, your authentication can forward the "Authorization" header of the incoming HTTP request to your
organization's OAuth 2.0 Identity Provider for authentication.</p>
<p>To return session information to the next function, the authentication function can return an EventEnvelope.
It can set the session information as key-values in the response event headers.</p>
<p>You can test this by visiting http://127.0.0.1:8086/api/hello/world to invoke the "hello.world" function.</p>
<p>The console will print:</p>
<pre><code class="language-shell">INFO {&quot;trace&quot;:{&quot;origin&quot;:&quot;11efb0d8fcff4924b90aaf738deabed0&quot;,
      &quot;id&quot;:&quot;4dd5db2e64b54eef8746ab5fbb4489a3&quot;,&quot;path&quot;:&quot;GET /api/hello/world&quot;,
      &quot;service&quot;:&quot;v1.api.auth&quot;,&quot;start&quot;:&quot;2023-06-10T00:01:07.492Z&quot;,&quot;success&quot;:true,
      &quot;exec_time&quot;:0.525,&quot;round_trip&quot;:0.8,&quot;from&quot;:&quot;http.request&quot;}} (handleEvent:tracer.js:27)
INFO {&quot;trace&quot;:{&quot;origin&quot;:&quot;11efb0d8fcff4924b90aaf738deabed0&quot;,
      &quot;id&quot;:&quot;4dd5db2e64b54eef8746ab5fbb4489a3&quot;,&quot;path&quot;:&quot;GET /api/hello/world&quot;,
      &quot;service&quot;:&quot;hello.world&quot;,&quot;start&quot;:&quot;2023-06-10T00:01:07.495Z&quot;,&quot;success&quot;:true,
      &quot;exec_time&quot;:0.478,&quot;round_trip&quot;:1.238,&quot;from&quot;:&quot;http.request&quot;}} (handleEvent:tracer.js:27)                              
</code></pre>
<p>This illustrates that the HTTP request has been processed by the "v1.api.auth" function.</p>
<p>The <code>tracing</code> parameter tells the system to turn on "distributed tracing". In the console log shown above, you see
two lines of log from "distributed trace" showing that the HTTP request is processed by "v1.api.auth" and
"hello.world" before returning result to the browser.</p>
<p>The optional <code>cors</code> and <code>headers</code> sections point to the specific CORS and HEADERS sections respectively.</p>
<h2 id="cors-section">CORS section</h2>
<p>For ease of development, you can define CORS headers using the CORS section like this.</p>
<p>This is a convenient feature for development. For cloud native production system, it is most likely that
CORS processing is done at the API gateway level.</p>
<p>You can define different sets of CORS headers using different IDs.</p>
<pre><code class="language-yaml">cors:
  - id: cors_1
    options:
      - &quot;Access-Control-Allow-Origin: ${api.origin:*}&quot;
      - &quot;Access-Control-Allow-Methods: GET, DELETE, PUT, POST, PATCH, OPTIONS&quot;
      - &quot;Access-Control-Allow-Headers: Origin, Authorization, X-Session-Id, X-Correlation-Id,
                                       Accept, Content-Type, X-Requested-With&quot;
      - &quot;Access-Control-Max-Age: 86400&quot;
    headers:
      - &quot;Access-Control-Allow-Origin: ${api.origin:*}&quot;
      - &quot;Access-Control-Allow-Methods: GET, DELETE, PUT, POST, PATCH, OPTIONS&quot;
      - &quot;Access-Control-Allow-Headers: Origin, Authorization, X-Session-Id, X-Correlation-Id, 
                                       Accept, Content-Type, X-Requested-With&quot;
      - &quot;Access-Control-Allow-Credentials: true&quot;
</code></pre>
<h2 id="headers-section">HEADERS section</h2>
<p>The HEADERS section is used to do some simple transformation for HTTP request and response headers.</p>
<p>You can add, keep or drop headers for HTTP request and response. Sample HEADERS section is shown below.</p>
<pre><code class="language-yaml">headers:
  - id: header_1
    request:
      #
      # headers to be inserted
      #    add: [&quot;hello-world: nice&quot;]
      #
      # keep and drop are mutually exclusive where keep has precedence over drop
      # i.e. when keep is not empty, it will drop all headers except those to be kept
      # when keep is empty and drop is not, it will drop only the headers in the drop list
      # e.g.
      # keep: ['x-session-id', 'user-agent']
      # drop: ['Upgrade-Insecure-Requests', 'cache-control', 'accept-encoding', 'host', 'connection']
      #
      drop: ['Upgrade-Insecure-Requests', 'cache-control', 'accept-encoding', 'host', 'connection']

    response:
      #
      # the system can filter the response headers set by a target service,
      # but it cannot remove any response headers set by the underlying servlet container.
      # However, you may override non-essential headers using the &quot;add&quot; directive.
      # i.e. don't touch essential headers such as content-length.
      #
      #     keep: ['only_this_header_and_drop_all']
      #     drop: ['drop_only_these_headers', 'another_drop_header']
      #
      #      add: [&quot;server: mercury&quot;]
      #
      # You may want to add cache-control to disable browser and CDN caching.
      # add: [&quot;Cache-Control: no-cache, no-store&quot;, &quot;Pragma: no-cache&quot;, 
      #       &quot;Expires: Thu, 01 Jan 1970 00:00:00 GMT&quot;]
      #
      add:
        - &quot;Strict-Transport-Security: max-age=31536000&quot;
        - &quot;Cache-Control: no-cache, no-store&quot;
        - &quot;Pragma: no-cache&quot;
        - &quot;Expires: Thu, 01 Jan 1970 00:00:00 GMT&quot;
</code></pre>
<h2 id="feature-variation-from-the-java-version">Feature variation from the Java version</h2>
<p>In the Node.js version, the underlying HTTP server is Express. We have configured the bodyParser to render
HTTP request body in this order:</p>
<ol>
<li>URL encoded parameters</li>
<li>JSON text</li>
<li>"application/xml" or content type starts with "text/"</li>
<li>"multipart/form-data" for file upload</li>
<li>all other types of content will be rendered as byte array (Buffer) with a payload limit of 2 MB
<br/></li>
</ol>
<table>
<thead>
<tr>
<th style="text-align: center;">Chapter-2</th>
<th style="text-align: center;">Home</th>
<th style="text-align: center;">Chapter-4</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><a href="../CHAPTER-2/">Function Execution Strategies</a></td>
<td style="text-align: center;"><a href="../TABLE-OF-CONTENTS/">Table of Contents</a></td>
<td style="text-align: center;"><a href="../CHAPTER-4/">Event Script Syntax</a></td>
</tr>
</tbody>
</table>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../CHAPTER-2/" class="btn btn-neutral float-left" title="Chapter-2"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../CHAPTER-4/" class="btn btn-neutral float-right" title="Chapter-4">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../CHAPTER-2/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../CHAPTER-4/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
