<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/accenture/mercury-nodejs/guides/CHAPTER-1/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Chapter-1 - Composable for Node.js</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Chapter-1";
        var mkdocs_page_input_path = "guides/CHAPTER-1.md";
        var mkdocs_page_url = "/accenture/mercury-nodejs/guides/CHAPTER-1/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Composable for Node.js
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../METHODOLOGY/">Methodology</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Chapter-1</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#composable-application-architecture">Composable application architecture</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#http-flow-adapter">HTTP flow adapter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#flow-configuration-example">Flow configuration example</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#assigning-a-route-name-to-a-user-function">Assigning a route name to a user function</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#building-the-mercury-libraries-from-source">Building the Mercury libraries from source</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#composable-application-example">Composable application example</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#starting-the-application">Starting the application</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#testing-the-application">Testing the application</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#main-application-entry-point">Main application entry point</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#graceful-shutdown">Graceful shutdown</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#commad-line-application">Commad line application</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dependency-management">Dependency management</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#component-scan">Component scan</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deploy-your-application">Deploy your application</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#event-choreography-by-configuration">Event choreography by configuration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#orchestration-by-code">Orchestration by code</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-2/">Chapter-2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-3/">Chapter-3</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-4/">Chapter-4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-5/">Chapter-5</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-6/">Chapter-6</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-7/">Chapter-7</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-8/">Chapter-8</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../APPENDIX-I/">Appendix-I</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../APPENDIX-II/">Appendix-II</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG/">Release notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../arch-decisions/DESIGN-NOTES/">Design notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../INCLUSIVITY/">Inclusivity</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CODE_OF_CONDUCT/">Code of Conduct</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING/">Contribution</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../TABLE-OF-CONTENTS/">Contents</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Composable for Node.js</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Chapter-1</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="introduction">Introduction</h1>
<p>Mercury Composable is a software development toolkit for writing composable applications.</p>
<p>Composable application means that an application is assembled from modular software components or functions that
are self-contained and pluggable. You can mix-n-match functions to form new applications. You can retire outdated
functions without adverse side effect to a production system. Multiple versions of a function can exist, and you
can decide how to route user requests to different versions of a function. Applications would be easier to design,
develop, maintain, deploy, and scale.</p>
<h2 id="composable-application-architecture">Composable application architecture</h2>
<blockquote>
<p>Figure 1 - Composable application architecture</p>
</blockquote>
<p><img alt="Composable Application Architecture" src="../diagrams/composable-framework.png" /></p>
<p>As shown in Figure 1, a composable application contains the following:</p>
<ol>
<li><em>Flow adapters</em>: Each flow adapter listens to requests for onwards delivery to an event manager.</li>
<li><em>Event Manager</em>: it sends events to a set of user functions for them to work together as an application.</li>
<li><em>User functions</em>: these are self-contained functions with clear input and output that are immutable.</li>
</ol>
<h3 id="http-flow-adapter">HTTP flow adapter</h3>
<p>A non-blocking HTTP flow adapter is built-in. For other external interface types, you can implement your own
flow adapters. e.g. Adapters for MQ, Kafka, Serverless, File based staging area, etc.</p>
<p>The standard HTTP flow adapter leverages the underlying REST automation system to serve user facing REST
API endpoints. For example, a hypothetical "get profile" endpoint is created like this in the "rest.yaml"
configuration file:</p>
<pre><code class="language-yaml">  - service: &quot;http.flow.adapter&quot;
    methods: ['GET']
    url: &quot;/api/profile/{profile_id}&quot;
    flow: 'get-profile'
    timeout: 10s
    cors: cors_1
    headers: header_1
    tracing: true
</code></pre>
<p>In this REST configuration entry, the system creates a REST API endpoint for "GET /api/profile/{profile_id}".
When a request arrives at this endpoint, the HTTP request will be converted to an incoming event by the flow adapter
that routes the event to the "event manager" to execute a new instance of the "get-profile" flow.</p>
<h3 id="flow-configuration-example">Flow configuration example</h3>
<p>The event manager is driven by configuration instead of code. A hypothetical "get profile" flow is defined in
a YAML file like this:</p>
<pre><code class="language-yaml">flow:
  id: 'get-profile'
  description: 'Get a user profile using profile ID'
  ttl: 10s
  exception: 'v1.hello.exception'

first.task: 'v1.get.profile'

tasks:
  - input:
      - 'input.path_parameter.profile_id -&gt; header.profile_id'
    process: 'v1.get.profile'
    output:
      - 'result -&gt; model.profile'
    description: 'Retrieve user profile from database using profile_id'
    execution: sequential
    next:
      - 'v1.decrypt.fields'

  - input:
      - 'model.profile -&gt; dataset'
      - 'text(telephone, address) -&gt; protected_fields'
    process: 'v1.decrypt.fields'
    output:
      - 'text(application/json) -&gt; output.header.content-type'
      - 'result -&gt; output.body'
    description: 'Decrypt fields'
    execution: end

  - input:
      - 'error.code -&gt; status'
      - 'error.message -&gt; message'
      - 'error.stack -&gt; stack'
    process: 'v1.hello.exception'
    output:
      - 'result.status -&gt; output.status'
      - 'result -&gt; output.body'
    description: 'Just a demo exception handler'
    execution: end
</code></pre>
<p>Note that the flow configuration is referring user functions by their "route" names. It is because all user functions
are self-contained with clearly defined input and output and the event manager would set their inputs and collect their
outputs accordingly. Note that you can map selected key-values or the whole event as a business object and this
decoupling promotes highly reusable user functional software.</p>
<p>The event manager will create a "state machine" to manage each transaction flow because all user functions are
stateless. The "state machine" is referenced using the namespace "model".</p>
<h3 id="assigning-a-route-name-to-a-user-function">Assigning a route name to a user function</h3>
<p>You can assign a route name to a Composite class using the <code>preLoad</code> annotation like this:</p>
<pre><code class="language-shell">export class GetProfile implements Composable {

    @preload('v1.get.profile', 10)
    initialize(): Composable {
        return this;
    }

    async handleEvent(evt: EventEnvelope) {
        // your business logic here
        return result;
    }
}
</code></pre>
<p>Inside the "handleEvent" method, you can write regular TypeScript code using your preferred coding style and
framework. You can define input/output as key-values (i.e. JSON objects).</p>
<h2 id="building-the-mercury-libraries-from-source">Building the Mercury libraries from source</h2>
<p>Assuming you clone the repository into the "sandbox" directory, you may build the libraries like this.</p>
<pre><code class="language-shell">cd sandbox/mercury-nodejs
npm install
npm run build
</code></pre>
<p>The compiled libraries will be saved to the distribution folder (<code>dist</code>). For production, you may publish
the distribution into your enterprise artifactory.</p>
<h2 id="composable-application-example">Composable application example</h2>
<p>Let's take a test drive of a composable application example in this repo:
<a href="https://github.com/Accenture/mercury-composable-examples">composable-example</a></p>
<p>To build the sample app, please clone example repo and build the application like this:</p>
<pre><code class="language-shell">cd sandbox/mercury-composable-examples
cd node/composable-example
npm install
npm run build
npm run test
</code></pre>
<p>When you build the composable example application, the first thing that you may notice is
that the build script will scan your source code and libraries. This is similar to the class
scanner feature in other languages. This feature is essential in composable application design 
because it decouples composable classes from each others so that they can be written in a 
self-contained manner. Your application does not need to import the classes. Instead, the class
scanner will create a "Composable class loader" during the build phase. The class loader will
then load the available composable classes and register them into the event loop.</p>
<p>Another important feature that you would find is that a composable application has a "resources"
folder in the "src" and "test" sections to hold application configuration files including event
flow YAML files. It supports hierarchy of configuration such that the system will search for 
configuration files in the libraries if your application does not provide a configuration file 
to override a default configuration file in the library. For example, your unit tests would
use a configuration file in the "src/resources" folder if it is not in the "tests/resources" folder.</p>
<p>For details, please refer to the Configuration management section in <a href="../APPENDIX-I/">Appendix-I</a></p>
<p>Your build log may look like this:</p>
<pre><code class="language-text">INFO Scanning ./node_modules/mercury-composable/dist (scanPackage:preloader.js:20)
INFO Class NoOp (scanLibrary:preloader.js:78)
INFO Scanning ./src (main:preloader.js:200)
INFO Class DemoAuth (scanSource:preloader.js:102)
INFO Class DemoHealthCheck (scanSource:preloader.js:102)
INFO Class HelloWorldService (scanSource:preloader.js:102)
INFO Class CreateProfile (scanSource:preloader.js:102)
INFO Class DecryptFields (scanSource:preloader.js:102)
INFO Class DeleteProfile (scanSource:preloader.js:102)
INFO Class EncryptFields (scanSource:preloader.js:102)
INFO Class GetProfile (scanSource:preloader.js:102)
INFO Class HelloException (scanSource:preloader.js:102)
INFO Class SaveProfile (scanSource:preloader.js:102)
INFO Composable class loader (/preload/preload.ts) generated (generatePreLoader:preloader.js:176)
</code></pre>
<p>The build script will compile your TypeScript source files into Javascript and then run the "preloader.js" script
to scan for your composable functions. Optionally, you can ask it to scan for composable libraries using the
"web.component.scan" parameter. In the above example, it scan for the package "mercury-composable" in the
"node_modules" folder and find the NoOp function.</p>
<p>The first step in designing a composable application is to draw an event flow diagram. This is similar to
a data flow diagram where the arrows are labeled with the event objects. Note that event flow diagram is
not a flow chart and thus decision box is not required. If a user function (also known as a "task") contains
decision logic, you can draw two or more output from the task to connect to the next set of functions.
For example, label the arrows as true, false or a number starting from 1.</p>
<p>The composable-example application is a hypothetical "profile management system" where you can create a profile,
browse or delete it.</p>
<blockquote>
<p>Figure 2 - Create a profile</p>
</blockquote>
<p><img alt="Event Flow Diagram" src="../diagrams/create-profile.png" /></p>
<p>Figure 2 illustrates an event flow to create a profile. Note that the "create profile" can send acknowledgement
to the user first. It then encrypts and saves the profile into a data store.</p>
<blockquote>
<p>Figure 3 - Retrieve a profile</p>
</blockquote>
<p><img alt="Event Flow Diagram" src="../diagrams/get-profile.png" /></p>
<p>Figure 3 demonstrates the case to retrieve a profile. It retrieves an encrypted profile and then passes it to
the decryption decryption function to return "clear text" of the profile to the user.</p>
<blockquote>
<p>Figure 4 - Delete a profile</p>
</blockquote>
<p><img alt="Event Flow Diagram" src="../diagrams/delete-profile.png" /></p>
<p>Figure 4 shows the case to delete a profile. It deletes a profile using the given profile ID and sends an
acknowledgement to the user.</p>
<p>The REST endpoints for the three use cases are shown in the "rest.yaml" configuration file under the "main/resources"
in the example subproject.</p>
<p>Extract of some configuration parameters in "application.yml" is shown below:</p>
<pre><code class="language-yaml">application.name: 'composable-example'
web.component.scan: 'mercury-composable'
server.port: 8086
rest.automation: true
yaml.rest.automation: classpath:/rest.yaml
yaml.flow.automation: classpath:/flows.yaml
</code></pre>
<p>The flow configuration files are shown in the "src/resources/flows" folder where you will find the flow configuration
files for the three event flows, namely get-profile.yml, delete-profile.yml and create-profile.yml.</p>
<h3 id="starting-the-application">Starting the application</h3>
<p>To run the composable-example application, you can do this:</p>
<pre><code class="language-shell">node dist/composable-example.js
</code></pre>
<p>When the application starts, you will see extract of the application log like this:</p>
<pre><code class="language-log">INFO Event system started - 15cda88cb4bf4f658357bb6007869296 (platform.js:503)
INFO PRIVATE distributed.tracing registered (platform.js:259)
INFO PRIVATE async.http.request registered with 200 instances (platform.js:262)
INFO PRIVATE no.op registered with 10 instances (platform.js:262)
INFO PRIVATE v1.api.auth registered (platform.js:259)
INFO PRIVATE demo.health registered (platform.js:259)
INFO PUBLIC hello.world registered with 10 instances (platform.js:262)
INFO PRIVATE v1.create.profile registered with 10 instances (platform.js:262)
INFO PRIVATE v1.decrypt.fields registered with 10 instances (platform.js:262)
INFO PRIVATE v1.delete.profile registered with 10 instances (platform.js:262)
INFO PRIVATE v1.encrypt.fields registered with 10 instances (platform.js:262)
INFO PRIVATE v1.get.profile registered with 10 instances (platform.js:262)
INFO PRIVATE v1.hello.exception registered with 10 instances (platform.js:262)
INFO PRIVATE v1.save.profile registered with 10 instances (platform.js:262)
INFO Loading event scripts from classpath:/flows.yaml (CompileFlows.start:compile-flows.js:72)
INFO Parsing create-profile.yml (CompileFlows.createFlow:compile-flows.js:108)
INFO Parsing delete-profile.yml (CompileFlows.createFlow:compile-flows.js:108)
INFO Parsing get-profile.yml (CompileFlows.createFlow:compile-flows.js:108)
INFO Loaded create-profile (CompileFlows.start:compile-flows.js:102)
INFO Loaded delete-profile (CompileFlows.start:compile-flows.js:102)
INFO Loaded get-profile (CompileFlows.start:compile-flows.js:102)
INFO Event scripts deployed: 3 (CompileFlows.start:compile-flows.js:104)
INFO Loading EventScriptManager as event.script.manager (FunctionRegistry.save:function-registry.js:33)
INFO PRIVATE event.script.manager registered (platform.js:259)
INFO Loading TaskExecutor as task.executor (FunctionRegistry.save:function-registry.js:33)
INFO PRIVATE task.executor registered (platform.js:259)
INFO Loading HttpToFlow as http.flow.adapter (FunctionRegistry.save:function-registry.js:33)
INFO PRIVATE http.flow.adapter registered with 200 instances (platform.js:262)
INFO To stop application, press Control-C (EventSystem.runForever:platform.js:589)
INFO Composable application started (main:composable-example.js:27)
INFO REST automation service started on port 8086 (rest-automation.js:443)
</code></pre>
<p>It shows that the 3 flow configuration files are compiled as objects to optimize performance. The user functions are
loaded into the event system and the REST endpoints are rendered from the "rest.yaml" file.</p>
<h3 id="testing-the-application">Testing the application</h3>
<p>You can create a test user profile with this python code. Alternatively, you can also use PostMan or other means
to do this.</p>
<pre><code class="language-python">&gt;&gt;&gt; import requests, json
&gt;&gt;&gt; d = { 'id': 100, 'name': 'Hello World', 'address': '100 World Blvd', 'telephone': '123-456-7890' }
&gt;&gt;&gt; h = { 'content-type': 'application/json', 'accept': 'application/json' }
&gt;&gt;&gt; r = requests.post('http://127.0.0.1:8100/api/profile', data=json.dumps(d), headers=h)
&gt;&gt;&gt; print(r.status_code)
201
&gt;&gt;&gt; print(r.text)
{
  &quot;profile&quot;: {
    &quot;address&quot;: &quot;***&quot;,
    &quot;name&quot;: &quot;Hello World&quot;,
    &quot;telephone&quot;: &quot;***&quot;,
    &quot;id&quot;: 100
  },
  &quot;type&quot;: &quot;CREATE&quot;,
  &quot;secure&quot;: [
    &quot;address&quot;,
    &quot;telephone&quot;
  ]
}
</code></pre>
<p>To verify that the user profile has been created, you can point your browser to</p>
<pre><code class="language-text">http://127.0.0.1:8100/api/profile/100
</code></pre>
<p>Your browser will return the following:</p>
<pre><code class="language-json">{
  &quot;address&quot;: &quot;100 World Blvd&quot;,
  &quot;name&quot;: &quot;Hello World&quot;,
  &quot;telephone&quot;: &quot;123-456-7890&quot;,
  &quot;id&quot;: 100
}
</code></pre>
<p>You have successfully tested the two REST endpoints. Tracing information in the application log may look like this:</p>
<pre><code class="language-log">DistributedTrace:76 - trace={path=POST /api/profile, service=http.flow.adapter, success=true, 
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:23.524Z, 
                            exec_time=0.284, from=http.request, id=f6a6ae62340e43afb0a6f30445166e08}
DistributedTrace:76 - trace={path=POST /api/profile, service=event.script.manager, success=true,
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:23.525Z,
                            exec_time=0.57, from=http.flow.adapter, id=f6a6ae62340e43afb0a6f30445166e08}
DistributedTrace:76 - trace={path=POST /api/profile, service=v1.create.profile, success=true,
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:23.526Z,
                            exec_time=0.342, from=task.executor, id=f6a6ae62340e43afb0a6f30445166e08}
DistributedTrace:76 - trace={path=POST /api/profile, service=async.http.response, success=true,
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:23.528Z,
                            exec_time=0.294, from=task.executor, id=f6a6ae62340e43afb0a6f30445166e08}
DistributedTrace:76 - trace={path=POST /api/profile, service=v1.encrypt.fields, success=true,
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:23.528Z,
                            exec_time=3.64, from=task.executor, id=f6a6ae62340e43afb0a6f30445166e08}
SaveProfile:52 - Profile 100 saved
TaskExecutor:186 - TaskExecutor:262 - {
  &quot;execution&quot;: &quot;Run 3 tasks in 11 ms&quot;,
  &quot;id&quot;: &quot;a0eef12d94bd4ab3b5fd6c25e2461130&quot;,
  &quot;flow&quot;: &quot;get-profile&quot;,
  &quot;tasks&quot;: [
    &quot;v1.create.profile&quot;,
    &quot;v1.encrypt.fields&quot;,
    &quot;v1.save.profile&quot;
  ],
  &quot;status&quot;: &quot;completed&quot;
}
DistributedTrace:76 - trace={path=POST /api/profile, service=v1.save.profile, success=true,
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:23.533Z,
                            exec_time=2.006, from=task.executor, id=f6a6ae62340e43afb0a6f30445166e08}
DistributedTrace:76 - trace={path=GET /api/profile/100, service=http.flow.adapter, success=true, 
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:52.089Z,
                            exec_time=0.152, from=http.request, id=1a29105044e94cc3ac68aee002f6f429}
DistributedTrace:76 - trace={path=GET /api/profile/100, service=event.script.manager, success=true,
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:52.090Z,
                            exec_time=0.291, from=http.flow.adapter, id=1a29105044e94cc3ac68aee002f6f429}
DistributedTrace:76 - trace={path=GET /api/profile/100, service=v1.get.profile, success=true,
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:52.091Z,
                            exec_time=1.137, from=task.executor, id=1a29105044e94cc3ac68aee002f6f429}
DistributedTrace:76 - trace={path=GET /api/profile/100, service=v1.decrypt.fields, success=true, 
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:52.093Z,
                            exec_time=1.22, from=task.executor, id=1a29105044e94cc3ac68aee002f6f429}
TaskExecutor:262 - {
  &quot;execution&quot;: &quot;Run 2 tasks in 7 ms&quot;,
  &quot;id&quot;: &quot;a0eef12d94bd4ab3b5fd6c25e2461130&quot;,
  &quot;flow&quot;: &quot;get-profile&quot;,
  &quot;tasks&quot;: [
    &quot;v1.get.profile&quot;,
    &quot;v1.decrypt.fields&quot;
  ],
  &quot;status&quot;: &quot;completed&quot;
}
DistributedTrace:76 - trace={path=GET /api/profile/100, service=async.http.response, success=true, 
                            origin=202406249aea0a481d46401d8379c8896a6698a2, start=2024-06-24T22:41:52.095Z, 
                            exec_time=0.214, from=task.executor, id=1a29105044e94cc3ac68aee002f6f429}
</code></pre>
<h3 id="main-application-entry-point">Main application entry point</h3>
<p>Every application has an entry point. The main entry point in the example app contains the entry point like this:</p>
<pre><code class="language-javascript">async function main() {
    // Load composable functions into memory and start the application modules
    await ComposableLoader.initialize();
}
// run the application
main();
</code></pre>
<p>The "ComposableLoader.initializer()" command will load the composable functions into the event loop
and run the application as a service.</p>
<p>If your application needs additional setup code, you can create a composable function like this:</p>
<pre><code class="language-javascript">export class MainApp implements Composable {

    @preload('main.app')
    initialize(): Composable {
        return this;
    }

    // This 'main.app' function is configured in the 'modules.autostart' parameter in application.yml
    // It will be started automatically.
    async handleEvent(evt: EventEnvelope) {
      // put business logic of any additional setup procedure here
      log.info(&quot;Application started&quot;);
      // release this function to guarantee that it is executed only once
      Platform.getInstance().release('main.app');
      // return value is ignored because start up code runs asynchronously
      return true;
    }
}
</code></pre>
<p>The above composable function is labeled as <code>main.app</code>, you would need to add this to the application.yml
as follows:</p>
<pre><code class="language-yaml">modules.autostart:
  - 'main.app'
  - 'flow://my-startup-flow'
</code></pre>
<p>For more sophisticated startup procedure, you can use a flow to execute multiple tasks. The second item in the
<code>modules.autostart</code> illustrates this use case.</p>
<blockquote>
<p><em>Note</em>: autostart modules or flows should assume there is no input dataset except a header ('type = start')
          to indicate that the request is triggered by "autostart" process.
          Startup modules usually take input parameters from the environment variables or a secret manager.</p>
</blockquote>
<h3 id="graceful-shutdown">Graceful shutdown</h3>
<p>If your application has some dependencies that must be shutdown gracefully, you can create a composable
function to handle the shutdown. The following configuration parameter in application.yml will invoke
the composable function with the route name "shutdown.hook". The system will wait for the completion
of the shutdown.hook before closing the application.</p>
<pre><code class="language-yaml">modules.autostop:
  - 'shutdown.hook'
</code></pre>
<blockquote>
<p><em>Note</em>: Similar to the autostart design, autostop modules should assume there is no input dataset except
          a header ('type = stop') to to indicate that the request is triggered by "autostop".
          For simplicity, the autostop feature does not support shutdown sequence using a flow.</p>
</blockquote>
<h3 id="commad-line-application">Commad line application</h3>
<p>If you want to run your application as a command line application instead of a service, your application
can close itself like this:</p>
<pre><code class="language-javascript">await platform.getReady();
// execute your business logic and then run the &quot;platform.stop()&quot; command to exit
await platform.stop();
</code></pre>
<h2 id="dependency-management">Dependency management</h2>
<p>As a best practice, your user functions should not have any dependencies with other user functions.</p>
<p>The second principle of composable design is "zero to one dependency". If your composable function must use
an external system, platform or database, you can encapsulate the dependency in a composable function.</p>
<h2 id="component-scan">Component scan</h2>
<p>Please update the following in the application.yml to include packages of your own functions:</p>
<pre><code class="language-properties">web.component.scan=your-package-name
</code></pre>
<blockquote>
<p>You should replace "your-package-name" with the real package name(s) that you use in your application.
  "web.component.scan" is a comma separated list of package names.</p>
</blockquote>
<h2 id="deploy-your-application">Deploy your application</h2>
<p>Composable design can be used to create microservices. You can put related functions in a bounded context with
database persistence.</p>
<p>Each composable application can be compiled and built into a single "executable" for deployment using
<code>npm run build</code>.</p>
<p>The executable Javascript application bundle is in the <code>dist</code> folder.</p>
<p>Composable application is by definition cloud native. It is designed to be deployable using Kubernetes or serverless.</p>
<h2 id="event-choreography-by-configuration">Event choreography by configuration</h2>
<p>The best practice for composable design is event choreography by configuration (<code>Event Script</code>) discussed above.
We will examine the Event Script syntax in <a href="../CHAPTER-4/">Chapter 4</a>.</p>
<p>Generally, you only need to use a very minimal set of mercury core APIs in your user function.
e.g. use PostOffice to obtain a trackable event emitter and AsyncHttpRequest to connect to external system.</p>
<p>For composable applications that use Event Script, Mercury core APIs (Platform, PostOffice and FastRPC) are only
required for writing unit tests, "custom flow adapters", "legacy functional wrappers" or "external gateways".</p>
<h2 id="orchestration-by-code">Orchestration by code</h2>
<p><em>Orchestration by code is strongly discouraged because it would result in tightly coupled code</em>.</p>
<p>For example, just an "Import" statement of another function would create tight coupling of two pieces of code,
even when using reactive or event-driven programming styles.</p>
<p>However, if there is a use case that you prefer to write orchestration logic by code, you may use the Mercury core
APIs to do event-driven programming. API overview will be covered in <a href="../CHAPTER-7/">Chapter 7</a>.
<br/></p>
<table>
<thead>
<tr>
<th style="text-align: center;">Methodology</th>
<th style="text-align: center;">Home</th>
<th style="text-align: center;">Chapter-2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><a href="../METHODOLOGY/">Methodology</a></td>
<td style="text-align: center;"><a href="../TABLE-OF-CONTENTS/">Table of Contents</a></td>
<td style="text-align: center;"><a href="../CHAPTER-2/">Function Execution Strategy</a></td>
</tr>
</tbody>
</table>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../METHODOLOGY/" class="btn btn-neutral float-left" title="Methodology"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../CHAPTER-2/" class="btn btn-neutral float-right" title="Chapter-2">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../METHODOLOGY/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../CHAPTER-2/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
